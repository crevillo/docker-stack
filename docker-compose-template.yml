### Notes
#
# - using the 'build' config instead of 'image' allows to build the platform with just 'docker-compose build'
# - SYS_PTRACE capability is needed to allow tghe containers to read /proc/$PID, which is needed by init scripts
#
# The docker-compose 'service' name corresponds to the top-level yml keys, whereas the container name is used in most
# 'docker' commands.
# Keeping a separate container name for each project allows to run many container platforms in parallel
version: '2'
networks:
    default:
        external:
            name: ${DOCKER_NETWORK_NAME}
services:
    web:
        extends:
            file: ${DOCKER_WEB_SERVER}.yml
            service: ${DOCKER_WEB_SERVER}
        hostname: web.${DOCKER_NETWORK_NAME}
        container_name: web
        ports:
            - "82:82"
            - "88:88"
        volumes:
            - "$DOCKER_WWW_ROOT:$DOCKER_WWW_DEST"
        env_file:
            - docker-compose.env
            - docker-compose.env.local
        cap_add:
            - SYS_PTRACE
        networks:
            - default
    front1:
        image: crevillo/front
        hostname: front1.${DOCKER_NETWORK_NAME}
        container_name: front1
        privileged: true
        volumes:
            - "$DOCKER_WWW_ROOT:$DOCKER_WWW_DEST"
            - ./logs/cli:/var/log/php
            # files in /tmp/cron.d get managed by bootstrap.sh
            - ./config/cli/cron.d:/tmp/cron.d
            - ~/.gitconfig:/home/site/.gitconfig
            - ~/.ssh/config:/home/site/.ssh/config
            - "$SSH_AUTH_SOCK:/ssh-agent"
            - "./config/cli/php5/custom_vars.ini:$DOCKER_PHP_CONF_PATH/cli/conf.d/custom_vars.ini"
            - "./config/cli/php5/timezone.ini:$DOCKER_PHP_CONF_PATH/cli/conf.d/timezone.ini"
        environment:
            - SSH_AUTH_SOCK=/ssh-agent
        env_file:
            - docker-compose.env
            - docker-compose.env.local
        cap_add:
            - SYS_PTRACE
        networks:
            - default
    back1:
        image: crevillo/back
        hostname: back1.${DOCKER_NETWORK_NAME}
        container_name: back1
        privileged: true
        volumes:
            - "$DOCKER_WWW_ROOT:$DOCKER_WWW_DEST"
            - ./logs/cli:/var/log/php
            # files in /tmp/cron.d get managed by bootstrap.sh
            - ./config/cli/cron.d:/tmp/cron.d
            - ~/.gitconfig:/home/site/.gitconfig
            - ~/.ssh/config:/home/site/.ssh/config
            - "$SSH_AUTH_SOCK:/ssh-agent"
            - "./config/cli/php5/custom_vars.ini:$DOCKER_PHP_CONF_PATH/cli/conf.d/custom_vars.ini"
            - "./config/cli/php5/timezone.ini:$DOCKER_PHP_CONF_PATH/cli/conf.d/timezone.ini"
        environment:
            - SSH_AUTH_SOCK=/ssh-agent
        env_file:
            - docker-compose.env
            - docker-compose.env.local
        cap_add:
            - SYS_PTRACE
        networks:
            - default
    db:
        image: klabs/mysql
        hostname: db.${DOCKER_NETWORK_NAME}
        container_name: db
        # nb: this prevents the image to start on some ubuntu installs because of apparmor config...
        #privileged: true
        ports:
            - "3307:3306"
        volumes:
            - ./config/mysql/:/etc/mysql/conf.d/
            - ./data/mysql/:/var/lib/mysql
            - ./logs/mysql/:/var/log/mysql
        env_file:
            - docker-compose.env
            - docker-compose.env.local
        cap_add:
            - SYS_PTRACE
        command: ["/root/bootstrap.sh", "mysqld --character-set-server=utf8 --collation-server=utf8_unicode_ci"]
        networks:
            - default
    redis:
        image: crevillo/redis
        hostname: redis.${DOCKER_NETWORK_NAME}
        container_name: redis
        ports:
            - "6379:6379"
        cap_add:
            - SYS_PTRACE
        networks:
            - default

